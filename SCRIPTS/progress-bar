#!/usr/bin/env python3
"""progress bar for dates or task files.
Usage:
    bar4.py --date [START_DATE] [TOTAL_DAYS]
    bar4.py --file FILE_PATH

    START_DATE – ISO format (YYYY-MM-DD). Defaults to 2025-11-16.
    TOTAL_DAYS – Number of days for scaling. Defaults to 60.
    FILE_PATH  – Path to the file to analyse.

    In DATE mode, progress bar shows the ratio of days already spent since START_DATE vs number of days specified in TOTAL_DAYS
    in FILE mode, progress bar shows the ration of uncommented vs commented lines in a file (starting with #)
"""

import argparse
import datetime
import sys

# Constants
TOTAL_BLOCKS = 60
# GREEN = "\033[32m" # ANSI green
# RESET = "\033[0m" # ANSI reset
# WHITE = "\033[37m" # ANSI white
GREEN = '${color green}' # conky green
RESET = '${color2}' # conky reset
WHITE = '${color white}' # conky white

# ---------------------------------------------------------------------------

def print_bar(green_blocks: int) -> None:
    """Print a 60‑character bar with the specified number of green blocks."""
    bar = []
    for _ in range(green_blocks):
        bar.append(f"{GREEN}▅{RESET}")
    for _ in range(TOTAL_BLOCKS - green_blocks):
        bar.append("▅")
    print("".join(bar), end="")

# ---------------------------------------------------------------------------

def date_mode(start_date: str, total_days: int) -> None:
    start = datetime.datetime.strptime(start_date, "%Y-%m-%d").date()
    today = datetime.date.today()
    days_diff = (today - start).days
    if days_diff < 0:
        days_diff = 0
    if total_days > 0:
        green_blocks = int((days_diff * TOTAL_BLOCKS) / total_days)
    else:
        green_blocks = 0
    green_blocks = min(max(green_blocks, 0), TOTAL_BLOCKS)
    print_bar(green_blocks)
    print(f"{WHITE} {days_diff} / {total_days}")

# ---------------------------------------------------------------------------

def file_mode(file_path: str) -> None:
    try:
        with open(file_path, "r", encoding="utf-8") as f:
            hash_lines = 0
            other_lines = 0
            for line in f:
                # Stop at a marker line such as '#--------'
                if line.lstrip().startswith("#-"):
                    break
                stripped = line.rstrip("\n")
                if stripped.startswith("#"):
                    hash_lines += 1
                elif stripped.strip():
                    other_lines += 1
    except FileNotFoundError:
        print(f"Error: File '{file_path}' not found.")
        sys.exit(1)

    total_lines = hash_lines + other_lines
    if total_lines == 0:
        print("No non‑empty lines found in file")
        sys.exit(0)

    green_blocks = int((hash_lines * TOTAL_BLOCKS) / total_lines)
    print_bar(green_blocks)
    print(f"{WHITE} {hash_lines} / {total_lines}")

# ---------------------------------------------------------------------------

def main() -> None:
    parser = argparse.ArgumentParser(description="Unified progress bar for dates or task files.")
    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument("--date", nargs="?", const="2025-11-16", help="Show date progress. Optional start date (YYYY-MM-DD).")
    group.add_argument("--file", help="Show file progress for the given file.")
    parser.add_argument("total_days", nargs="?", type=int, default=60, help="Total days for date scaling (default 60).")

    args = parser.parse_args()

    if args.date is not None:
        # In --date mode, args.date holds the start date (or default)
        date_mode(args.date, args.total_days)
    else:
        file_mode(args.file)


if __name__ == "__main__":
    main()
